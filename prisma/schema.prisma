// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Session storage model
model Session {
  sid    String   @id @db.VarChar
  sess   Json     @db.Json
  expire DateTime @db.Timestamp(6)

  @@index([expire], map: "IDX_session_expire")
  @@map("sessions")
}

// User model
model User {
  id               String    @id @db.VarChar
  email            String?   @unique @db.VarChar
  firstName        String?   @db.VarChar
  lastName         String?   @db.VarChar
  profileImageUrl  String?   @db.VarChar
  password         String?   @db.VarChar
  role             String    @default("user") @db.VarChar
  isActive         Boolean   @default(true)
  isVerified       Boolean   @default(false)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // Relations
  products         Product[]
  reviews          Review[]
  cartItems        CartItem[]
  wishlistItems    WishlistItem[]
  orders           Order[]
  chatRoomsAsCustomer ChatRoom[] @relation("CustomerChatRooms")
  chatRoomsAsAgent ChatRoom[] @relation("AgentChatRooms")
  chatMessages     ChatMessage[]
  properties       Property[]
  guestBookings    Booking[] @relation("GuestBookings")
  propertyReviews  PropertyReview[]
  payments         Payment[]
  itineraries      Itinerary[]

  @@map("users")
}

// Category model
model Category {
  id          Int      @id @default(autoincrement())
  name        String   @db.VarChar(100)
  slug        String   @unique @db.VarChar(100)
  description String?  @db.Text
  parentId    Int?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  products    Product[]

  @@map("categories")
}

// Product model
model Product {
  id          Int      @id @default(autoincrement())
  sellerId    String   @db.VarChar
  title       String   @db.VarChar(200)
  description String?  @db.Text
  price       Decimal  @db.Decimal(10, 2)
  categoryId  Int
  stock       Int      @default(0)
  images      String[] @db.Text
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  seller       User           @relation(fields: [sellerId], references: [id])
  category     Category       @relation(fields: [categoryId], references: [id])
  reviews      Review[]
  cartItems    CartItem[]
  wishlistItems WishlistItem[]
  orderItems   OrderItem[]

  @@map("products")
}

// Review model
model Review {
  id        Int      @id @default(autoincrement())
  userId    String   @db.VarChar
  productId Int
  rating    Int
  comment   String?  @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user    User    @relation(fields: [userId], references: [id])
  product Product @relation(fields: [productId], references: [id])

  @@map("reviews")
}

// Cart Item model
model CartItem {
  id        Int      @id @default(autoincrement())
  userId    String   @db.VarChar
  productId Int
  quantity  Int      @default(1)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user    User    @relation(fields: [userId], references: [id])
  product Product @relation(fields: [productId], references: [id])

  @@map("cart_items")
}

// Wishlist Item model
model WishlistItem {
  id        Int      @id @default(autoincrement())
  userId    String   @db.VarChar
  productId Int
  createdAt DateTime @default(now())

  // Relations
  user    User    @relation(fields: [userId], references: [id])
  product Product @relation(fields: [productId], references: [id])

  @@map("wishlist_items")
}

// Order model
model Order {
  id              Int      @id @default(autoincrement())
  userId          String   @db.VarChar
  status          String   @default("pending") @db.VarChar(20)
  totalAmount     Decimal  @db.Decimal(10, 2)
  shippingAddress Json?    @db.Json
  paymentMethod   String?  @db.VarChar(50)
  paymentStatus   String?  @default("pending") @db.VarChar(20)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  user       User        @relation(fields: [userId], references: [id])
  orderItems OrderItem[]

  @@map("orders")
}

// Order Item model
model OrderItem {
  id        Int     @id @default(autoincrement())
  orderId   Int
  productId Int
  quantity  Int
  price     Decimal @db.Decimal(10, 2)

  // Relations
  order   Order   @relation(fields: [orderId], references: [id])
  product Product @relation(fields: [productId], references: [id])

  @@map("order_items")
}

// Chat Room model
model ChatRoom {
  id              Int       @id @default(autoincrement())
  customerId      String    @db.VarChar
  supportAgentId  String?   @db.VarChar
  status          String    @default("active") @db.VarChar(20)
  subject         String?   @db.VarChar(255)
  priority        String    @default("medium") @db.VarChar(20)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  closedAt        DateTime?

  // Relations
  customer     User          @relation("CustomerChatRooms", fields: [customerId], references: [id])
  supportAgent User?         @relation("AgentChatRooms", fields: [supportAgentId], references: [id])
  messages     ChatMessage[]

  @@map("chat_rooms")
}

// Chat Message model
model ChatMessage {
  id          Int      @id @default(autoincrement())
  roomId      Int
  senderId    String   @db.VarChar
  message     String   @db.Text
  messageType String   @default("text") @db.VarChar(20)
  isRead      Boolean  @default(false)
  createdAt   DateTime @default(now())

  // Relations
  room   ChatRoom @relation(fields: [roomId], references: [id])
  sender User     @relation(fields: [senderId], references: [id])

  @@map("chat_messages")
}

// Property model
model Property {
  id             Int      @id @default(autoincrement())
  hostId         String   @db.VarChar
  title          String   @db.VarChar(200)
  description    String?  @db.Text
  propertyType   String   @db.VarChar(50)
  roomType       String   @db.VarChar(50)
  maxGuests      Int
  bedrooms       Int      @default(1)
  bathrooms      Int      @default(1)
  pricePerNight  Decimal  @db.Decimal(10, 2)
  cleaningFee    Decimal  @default(0) @db.Decimal(10, 2)
  serviceFee     Decimal  @default(0) @db.Decimal(10, 2)
  address        String   @db.Text
  city           String   @db.VarChar(100)
  state          String?  @db.VarChar(100)
  country        String   @db.VarChar(100)
  zipCode        String?  @db.VarChar(20)
  latitude       Decimal? @db.Decimal(10, 8)
  longitude      Decimal? @db.Decimal(11, 8)
  images         String[] @db.Text
  amenities      String[] @db.Text
  isActive       Boolean  @default(true)
  instantBook    Boolean  @default(false)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  host            User             @relation(fields: [hostId], references: [id])
  bookings        Booking[]
  reviews         PropertyReview[]
  availability    PropertyAvailability[]
  roomAvailability RoomAvailability[]

  @@map("properties")
}

// Booking model
model Booking {
  id            Int      @id @default(autoincrement())
  propertyId    Int
  guestId       String   @db.VarChar
  checkIn       DateTime @db.Date
  checkOut      DateTime @db.Date
  guests        Int
  totalAmount   Decimal  @db.Decimal(10, 2)
  status        String   @default("pending") @db.VarChar(20)
  specialRequests String? @db.Text
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  property Property @relation(fields: [propertyId], references: [id])
  guest    User     @relation("GuestBookings", fields: [guestId], references: [id])
  review   PropertyReview?

  @@map("bookings")
}

// Property Review model
model PropertyReview {
  id           Int      @id @default(autoincrement())
  propertyId   Int
  bookingId    Int      @unique
  userId       String   @db.VarChar
  rating       Int
  cleanliness  Int?
  communication Int?
  checkIn      Int?
  accuracy     Int?
  location     Int?
  value        Int?
  comment      String?  @db.Text
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  property Property @relation(fields: [propertyId], references: [id])
  booking  Booking  @relation(fields: [bookingId], references: [id])
  user     User     @relation(fields: [userId], references: [id])

  @@map("property_reviews")
}

// Property Availability model
model PropertyAvailability {
  id          Int      @id @default(autoincrement())
  propertyId  Int
  date        DateTime @db.Date
  available   Boolean  @default(true)
  customPrice Decimal? @db.Decimal(10, 2)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  property Property @relation(fields: [propertyId], references: [id])

  @@unique([propertyId, date])
  @@map("property_availability")
}

// Room Availability model
model RoomAvailability {
  id             Int      @id @default(autoincrement())
  propertyId     Int
  date           DateTime @db.Date
  availableRooms Int      @default(0)
  totalRooms     Int      @default(1)
  priceOverride  Decimal? @db.Decimal(10, 2)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  property Property @relation(fields: [propertyId], references: [id])

  @@unique([propertyId, date])
  @@map("room_availability")
}

// Payment model
model Payment {
  id            Int      @id @default(autoincrement())
  userId        String   @db.VarChar
  bookingId     Int?
  amount        Decimal  @db.Decimal(10, 2)
  currency      String   @default("VND") @db.VarChar(3)
  status        String   @default("pending") @db.VarChar(20)
  paymentMethod String   @db.VarChar(50)
  transactionId String?  @db.VarChar(100)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id])

  @@map("payments")
}

// Itinerary model
model Itinerary {
  id          Int      @id @default(autoincrement())
  userId      String   @db.VarChar
  title       String   @db.VarChar(200)
  description String?  @db.Text
  destination String   @db.VarChar(100)
  startDate   DateTime @db.Date
  endDate     DateTime @db.Date
  totalBudget Decimal? @db.Decimal(10, 2)
  status      String   @default("planning") @db.VarChar(20)
  isPublic    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id])
  days ItineraryDay[]

  @@map("itineraries")
}

// Itinerary Day model
model ItineraryDay {
  id          Int      @id @default(autoincrement())
  itineraryId Int
  dayNumber   Int
  date        DateTime @db.Date
  title       String?  @db.VarChar(200)
  notes       String?  @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  itinerary  Itinerary @relation(fields: [itineraryId], references: [id])
  activities ItineraryActivity[]

  @@map("itinerary_days")
}

// Itinerary Activity model
model ItineraryActivity {
  id          Int      @id @default(autoincrement())
  dayId       Int
  title       String   @db.VarChar(200)
  description String?  @db.Text
  startTime   DateTime? @db.Time
  endTime     DateTime? @db.Time
  location    String?  @db.VarChar(200)
  cost        Decimal? @db.Decimal(10, 2)
  category    String?  @db.VarChar(50)
  orderIndex  Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  day ItineraryDay @relation(fields: [dayId], references: [id])

  @@map("itinerary_activities")
}